---
title:  "如何用凯利公式来管理基金仓位"
date: 2020-06-23T16:32:56+08:00
tags: [仓位,凯利公式]
comment: true
---

## 前言

仓位管理是投资时的一个基础要点，有人动辄满仓空仓，有人二股八债轮动、有人按部就班按估值建仓，貌似没有标准去界定一个合理仓位区间。

我接触长赢指数投资后，得出的结论是使用估值分位数，估值和分位数越低，显然胜率越大，那么投注的比例也应该越大，大致的公式是

> f = 1 - q

1. f是仓位
2. P是估值分位

比如估值点的分位数是15%，那么仓位应该在85%。

再后来了解到凯利公式，遂发现很多人推崇这儿公式，结果在多数时候也还凑合，然而其背后的假设和结果的意义却被忽视。

本文主要探讨，凯利公式的局限性，以及如何确定仓位。

## 分位的概念

要理解凯利公式和投资下注的比例，就要先理解分位数这个概念。

在数学上分位数代表的是一个样本（估值）在从小到大样本空间内（所有历史估值）的小于该样本的频率统计值，直白理解是**在历史上出现过低于估值的频率是XX百分比**。

比如说，中证红利PE估值10的分位数是6%，那么代表着在历史上中证红利出现估值10以下的频率只有15%。

由于我们相信市场有效假说，相信均值回归理论，同时从历史PE规律（确实有很多的假设前提），我们确定6-10内（又一个时间假设），此刻买入后的胜率的是1-6% = 94%。

诸多的假设和分位值一同构成我们决策仓位的依据，缺一不可。如果我们不相信市场均值回归，持有的资产拿不到10年后（比如亏损后中途下车，或者3年后就调整了策略），那么这个结论就不成立。

好了，**那么在胜率95%的前提下，我们该投入多少本金才是最优？**。为什么这么问，因为如果仓位过重，遭遇黑天鹅就会放大损失，投入过少时收益率又不足，这个问题其实就是凯利公式要解决的。

## 什么是凯利公式

来自维基百科的定义，

> 凯利公式（英语：Kelly formula），也称凯利方程式，是一个用以使特定赌局中，拥有正期望值之重复行为长期增长率最大化的公式，由约翰·拉里·凯利于1956年在《贝尔系统技术期刊》中发表，可用以计算出每次游戏中应投注的资金比例。除可将长期增长率最大化外，此方程式不允许在任何赌局中，有失去全部现有资金的可能，因此有不存在破产疑虑的优点。方程式假设货币与赌局可无穷分割，而只要资金足够多，在实际应用上不成问题。

常见的简化公式，

![20200624151354](https://cdn.jsdelivr.net/gh/leeleilei/leeleilei.github.io/assets/images/20200624151354.png)
或者 另一种推导形式，

![20200624100634](https://cdn.jsdelivr.net/gh/leeleilei/leeleilei.github.io/assets/images/20200624100634.png)

1. f是自己所剩余的预备投注的资金比例
2. p为赢的概率
3. rw(return of win) 是赢时的净收益率，不含本金，例如在赌局1中rw=1，表示完全损失本金。投资基金时，就是牛市顶峰我们的收益率。
4. rl(return of loss) 是输时的净损失率，例如在赌局1中rl=1，表示赚取一倍的收益，注意此处rl>0
5. b表示投注可得的赔率，不含本金

凯利公式的数学推论非常复杂，我不是数学专业也说不出个屁来，但不影响主观的理解其原理、局限性。

## 局限和意义

这个公式跟概率论有关，**所有涉及概率的都会有大的假设，比如样本空间**。举个例子，都知道投掷硬币时正面的概率是50%，那么是不是打赌时投掷正面出现频率一定是50%呢？

其实不是，我们打赌是有限次数，出现正面的次数绝对不是50%。如果约定，不吃不喝每时每刻投掷硬币几个月，此时的频率分布才接近50%。

无限样本空间是概率论的基础，数量会稀释掉反面比例，趋于回归值，而不是提高了正面的概率。

同理，**如果将凯利公式应用于投资市场，那么就假设了赌局无限分割，也就是无限次的参与设置仓位，无限的资金可以补仓。** 

显然，这是不可能的，人的一生只有几十年，大概经历3次低估，会跟这个模型的预期产生非常大的差异。就像你打赌投掷硬币4次，你说概率是50%，最多输2次，实际可能输4次，胜率是0。

另外，凯利公式是对赌模型，也就是你输我赢的零和市场的行为，用在赌博游戏、期货市场（对赌）是有效的。

用在股票、基金市场，这个对赌模型就有了另外的意义，变成我（投资人）和市场价格（所有其他全体）的对赌，赔率就是低位和高位的价格比，胜率就是一定时期（10年内）内估值（一个指标）的回归概率。这个数学意义倒是问题不大，没有偏离模型太多。

## 简化版的凯利公式

在投资论坛中常看到另一种简化形式，

> f = 2p -1

其实是假设了rw, rl = 1，就是赌博的情形，赢了翻倍，输了为0。公式依赖于胜率p，由于我们使用估值分位来替代胜率，所以可以得出

> f = 1 - 2q

q 就是 估值分位，也就是越低分位，输的概率越低。可以看出当估值处于50%以下时，可以采取行动买入，否则就应按等待。

## 动态/杠杆版本

实际投资时，rw和rl不是1，rw在牛市高峰预期收益rw可能是2倍，对于rl存在一个最大回撤，有一个保底价格。

例如PE 10，分位数是5%，此时买入，按照估值和价格历史对应关系，PE最大时价格rw=1.5，PE最低8，价格最大回撤15%，那么计算结果应该是，

> f = 0.85/0.15 - 0.15/1.5 = 6 

也就是可以投入600%的仓位去投资，意思是可以加6倍的杠杆，我？？？

![20200624144127](https://cdn.jsdelivr.net/gh/leeleilei/leeleilei.github.io/assets/images/20200624144127.png)

## 为什么结果出入这么大

这个结果是真实的，但是存在一些假定的前提。还记得开篇凯利公式假设吗，赌局可以无限分割（发生次数），资金永远充足。

这个结果的现实意义在于，未来你还有无数次的机会去做同样的动作，无限次经历钻石底，无限次的投注，经历2015年-2020年牛熊交替后，最终你的胜率。

然而实际情况呢，A股有效数据历史一共20年，PE 5%分位的次数一共3次，且不说模型的有效性，未来一个投资人能有几次机会？可能一次就破产了，不会再有很多次去做同样的赌注来弥补单次的损失。

所以这个结果有效，但没有实际操作用途。

## 开下脑壳

那么是不是一个富二代，增加交易次数就可以模拟无限分割，然后一定盈利呢？

理论上是的，但是产生这个概率的对象要调整，钻石底不可能发生很多次。需要找一个有效指标，这个指标跟盈利有大于50%的相关性，且样本足够支撑相关性。比如一个分钟级别的指标，出现某种波动时，盈利概率大于55%，那么这个指标有效，就可以无限次的交易，用大数概率来磨平短期的亏损。（当然也要考虑交易损耗等）

等等，我好想发现了致富的路子！找到这个指标不就行了？是的，这也是全球的量化精英们，穷极一生在做的事情，鲜有人成功。当你成功时，指标会被复制粘贴，在市场中失效。

## 那么到底如何确定仓位

靠玄学吗？还真是，多数人靠的是经验，最初提到的2P-1其实也是一个经验值。

从长赢指数投资的经验来看，首先仓位用作整体资金配置的估算，比如益达建议你当前环境下，持仓最低多少最多是多少。不会告诉你养老产业的持仓应该是多少。

从以往数据推理，长赢的资产仓位大致符合 f = 2P - 1，并在此基础上给出5-10%点的削减预留（应对黑天鹅）。


## 进一步的思考

如果真要去确定一个准确的仓位值，可以用回测模拟的方法来回归一个值，设置不同的持仓，针对长赢策略，看看哪个仓位规则下，获取的收益最大。

用这个方法得出的值才基本可信，但不是100准确，。我们都知道过去不代表未来，回测的样本也非常小，况且不同的标的，PE趋势不同，仓位值可能又不同。

## 注意事项

因为我们推崇的是长期资产配置，低买高卖，交易的频率很低，交易的时间集中在指数低估期间和高估值卖出区间。

比如，估值分位20%以下和80%以上是买入和卖出时刻。所以在估值正常的区间，是不需要关注和调整持仓份额的。

## 尾声

凯利公式及其简化版本给基金持仓份额提供了一种简洁的配置思路

> f = 1 - 2q (q是估值分位值)

从经验看，这个公式能够较好的指导我们的整体仓位（还没看到相关的有效性验证文章）。

另外，公式很明显的告诉我两个原则：

1. 如果f算出来是0，表示这是一个期望收益为0的游戏，最优决策是不参加。
1. 如果f算出来是负数，表示这是一个期望收益为负的游戏，更是不能参加了

也就是分位数在50%以上时，对于长期资产配置来说，就不要买入了。
